#!/usr/bin/perl 

use strict;

use lib "@targetDir@/lib/perl";
$ENV{GUS_HOME} = '@targetDir@';

use OrthoMCLData::Load::MatrixColumnManager;
use ApiCommonWebsite::Model::ModelConfig;

my $groupName = $ARGV[0] || die "usage: orthomclGroupProfile group_name \n";

my $colMgr = OrthoMCLData::Load::MatrixColumnManager->new($dbh);

my $dbh = &getDbHandle();
my $sql = "
select m.*
from apidb.grouptaxonmatrix m, apidb.orthologgroup g
where g.name = '$name'
and  m.ortholog_group_id = g.ortholog_group_id
";

my $stmt = &getDbHandle()->prepare($sql);
$stmt->execute();
while (my $row = $stmt->getrow_hashref()) {
  foreach my $colName (keys(%$row)) {
    my ($taxonAbbrev, $proteinOrTaxonFlag) = $colMgr->getTaxonAbbrev($col);
    if ($proteinOrTaxonFlag eq 'P') {
	$proteinCounts->{$taxonAbbrev} = $row->{$colName};
    } else {
	$taxonCounts->{$taxonAbbrev} = $row->{$colName};
    }
  }
}

my $clades;
open(SPECIES, $speciesFile) || die "can't open species file '$speciesFile'\n";
while (<SPECIES>) {
    chomp;
    my ($species, $clade) = split(/\t/);
    $clades->{$clade} = [] unless $clades->{$clade};
    push(@{$clades->{$clade}}, $species);
}
close(SPECIES);

open(CLADE, $cladeFile) || die "can't open clade file '$cladeFile'\n";
my $pipes = '| | | | | | | | | | | | | | | | | | | | | ';
while (<CLADE>) {
    chomp;
    /^([\|\s\s]*)([A-Z]{3})/;
    my $indent = $1;
    my $cladeAbbrev = $2;
    print "$indent $cladeAbbrev  T:$taxonCounts->{$clade}  P:$proteinCounts->{$clade}\n";
    foreach my $species (@{$clades->{$clade}}) {
	print "$indent $species T:$taxonCounts->{$species}  P:$proteinCounts->{$species}\n" if $proteinCounts->{$species};
    }
			 
}

sub getDbHandle {
  my $c = new ApiCommonWebsite::Model::ModelConfig($model);

  my $dsn = $c->getDbiDsn();
  my $login = $c->getLogin();

  my $dbh = DBI->connect(
                $c->getDbiDsn, 
                $c->getLogin, 
                $c->getPassword,
                { PrintError => 1, RaiseError => 0}
                ) or die "Can't connect to the database: $DBI::errstr\n";
  return $dbh;
}
